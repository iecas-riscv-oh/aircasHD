"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,i)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SyscapTransform=void 0;const ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),process_utils_js_1=require("../utils/process-utils.js"),common_const_js_1=require("../const/common-const.js"),path_1=__importDefault(require("path")),file_util_js_1=require("../utils/file-util.js"),fs=__importStar(require("fs")),array_util_js_1=require("../utils/array-util.js"),fse=__importStar(require("fs-extra")),lodash_1=require("lodash"),project_file_reader_js_1=require("../utils/project-file-reader.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js");var Task=task_names_js_1.TaskNames.Task;class SyscapTransform extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,Task.SYSCAP_TRANSFORM),this._log=ohos_logger_js_1.OhosLogger.getLogger(SyscapTransform.name),this.hapExtraInfo=e.getHapExtraInfo()}initTaskDepends(){}doTaskAction(e){var t,s;const o=null===(t=this.service.getModuleModel())||void 0===t?void 0:t.getSourceRootByTargetName(e.getTargetName()),i=e.getPathInfo(),r=this.service.getSdkInfo(),n=r.getSdkEtsDir(),a=r.getSdkJsDir(),l=r.getSysCapFileInEts(),c=r.getSysCapFileInJs(),_=/^SystemCapability(\.[a-zA-Z0-9]+){2,3}$/;let d,u,f,h;if(this.hapExtraInfo.isStageMode()){const e=path_1.default.resolve(o,common_const_js_1.CommonConst.MODULE_JSON5);u=project_file_reader_js_1.ProjectFileReader.getJson5Obj(e).module.deviceTypes,d=e,f="deviceTypes",h="module.json5"}else{const e=path_1.default.resolve(o,common_const_js_1.CommonConst.CONFIG_JSON);u=project_file_reader_js_1.ProjectFileReader.getJson5Obj(e).module.deviceType,d=e,f="deviceType",h="config.json"}const p=path_1.default.resolve(o,common_const_js_1.CommonConst.SYSCAP_JSON);if(fs.existsSync(p)){const e=project_file_reader_js_1.ProjectFileReader.getJson5Obj(p),t=e.devices,o=t.general,r=t.custom,d=[],g=[];let m=[];if(0===u.length){if(void 0!==o&&0!==o.length){const e=`The value of 'general' in the syscap.json file must be the same as that of \n          '${f}' in the ${h} file.`,t=`Please check whether the general field in the syscap.json file and the \n          ${f} field in the ${h} are correctly configured.`;this._log._buildError(e)._solution(t)._file(p)._printErrorAndExit()}m=this.intersectNDeviceSysCap(r,g,_,p)}else{if(void 0===o||!(0,array_util_js_1.checkArrayElementIsSame)(o,u)){const e=`The 'general' field in the syscap.json file must exist, and its value must be the same as \n          the value of '${f}' in the ${h} file.`,t=`Please check whether the syscap.json, ${h} files \n          are correctly configured.`;this._log._buildError(e)._solution(t)._file(p)._printErrorAndExit()}if(o.forEach((e=>{fs.existsSync(a)&&!fs.existsSync(n)?this.getRequireSysCapList(c,e,d):this.getRequireSysCapList(l,e,d)})),void 0!==r){const e=this.intersectNDeviceSysCap(r,g,_,p);m=e.filter((e=>d.includes(e)))}}if(this.moduleModel.isHarModule())return;const y=e.production;if(void 0!==y&&(void 0!==y.addedSysCaps&&0!==y.addedSysCaps.length&&y.addedSysCaps.forEach((e=>{this.fieldRegExpCheck(e,"addedSysCaps",_,p),m.includes(e)||m.push(e)})),void 0!==y.removedSysCaps&&0!==y.removedSysCaps.length&&y.removedSysCaps.forEach((e=>{this.fieldRegExpCheck(e,"removedSysCaps",_,p),m.includes(e)&&m.splice(m.indexOf(e),1)}))),0===m.length)return;const j=new Map,S=null===(s=this.service.getModuleModel())||void 0===s?void 0:s.getCompileApiVersion();j.set("api_version",S),j.set("syscap",m);const v=i.getIntermediatesSysCap();file_util_js_1.FileUtil.checkDirWithoutDelete(v);const C=path_1.default.resolve(v,common_const_js_1.CommonConst.RPCID_JSON);fse.outputJsonSync(C,Object.fromEntries(j));const E=this.service.getSdkInfo().getSysCapTool();new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync([E,"-R","-e","-i",C,"-o",v])}else if(0===u.length){const e=`The '${f}' field in the ${h} file may be empty or does not exist.`,t=`If the '${f}' field in the ${h} file is empty or does not exist, \n      import and correctly configure the syscap.json file.`;this._log._buildError(e)._solution(t)._file(d)._printErrorAndExit()}}getRequireSysCapList(e,t,s){fs.readdirSync(e).forEach((o=>{if(o.toString().slice(0,o.toString().indexOf("."))===t){project_file_reader_js_1.ProjectFileReader.getJson5Obj(path_1.default.resolve(e,o.toString())).SysCaps.forEach((e=>{s.some((t=>t===e))||s.push(e)}))}}))}intersectNDeviceSysCap(e,t,s,o){if(void 0!==e){e.forEach((e=>{Object.keys(e).forEach((s=>{t.push(e[s])}))}));for(let e=0;e<t.length;e++)for(let i=0;i<t[e].length;i++)this.fieldRegExpCheck(t[e][i],"custom",s,o)}return(0,lodash_1.intersection)(...t)}fieldRegExpCheck(e,t,s,o){if(!s.test(e)){const e=`Please check whether the value of '${t}' in the syscap.json is correct.`,i=`Configure correct sysCaps in '${t}' according to the pattern:'${s}'.`;this._log._buildError(e)._solution(i)._file(o)._printErrorAndExit()}}}exports.SyscapTransform=SyscapTransform;