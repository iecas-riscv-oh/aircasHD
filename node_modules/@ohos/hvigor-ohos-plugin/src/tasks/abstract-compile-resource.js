"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,s)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractCompileResource=void 0;const ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),restool_command_builder_js_1=require("../builder/restool-command-builder.js"),path_1=__importDefault(require("path")),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_utils_js_1=require("../utils/process-utils.js"),restool_file_config_builder_js_1=require("../builder/restool-file-config-builder.js"),fse=__importStar(require("fs-extra")),build_directory_const_js_1=require("../const/build-directory-const.js");class AbstractCompileResource extends ohos_hap_task_js_1.OhosHapTask{getResToolFile(){return this.service.getSdkInfo().getRestool()}getCommonResToolBuilder(e,t=!0){const o=this.initTargetResource(t,e);o.addModules(this.getRestoolModules(e).join(",")).forceDelete();return this.service.getDependencyRootPaths().forEach((e=>{t?o.addInputDir(path_1.default.resolve(e,"src","main",build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),"Har"):o.addInputDir(path_1.default.resolve(e,"src","main"))})),o}initTargetResource(e,t){var o;const r=this.service.getModuleModel();if(!e)return new restool_command_builder_js_1.RestoolCommandBuilder(this.getResToolFile()).addInputDir(r.getSourceSetByTargetName(t.getTargetName()).getSourceSetRoot());const s=new restool_file_config_builder_js_1.RestoolConfigBuilder,i=null===(o=t.getTargetOpt().resource)||void 0===o?void 0:o.directories;return void 0===i?s.addInputDir(path_1.default.resolve(r.getSourceSetByTargetName(t.getTargetName()).getSourceSetRoot(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),"Module"):i.forEach((e=>{const t=path_1.default.isAbsolute(e)?e:path_1.default.resolve(r.getProjectDir(),e);fse.existsSync(t)||ohos_logger_js_1.OhosLogger.getLogger(AbstractCompileResource.name)._buildError(`${t} not exists.`)._file(r.getProfilePath())._printWarn(this.moduleName),s.addInputDir(t,"Module")})),s}getRestoolModules(e){return[...new Set([this.moduleModel.getName(),this.moduleModel.getSourceSetByTargetName(e.getTargetName()).getLegacyModuleTargetRes().getConfigJsonOpt().module.distro.moduleName,...this.service.getProjectModel().getSubProjects().keys()])]}compile(e,t){const o=e.build();t._printDebugCommand("restool",o),new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(o)}compileResources(e,t,o){const r=t.getConfigObject();fse.outputJSONSync(e,r);const s=[this.getResToolFile(),"-l",e];o._printDebugCommand("restool",s),new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(s)}}exports.AbstractCompileResource=AbstractCompileResource;