"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var a=Object.getOwnPropertyDescriptor(t,o);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,a)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractMakePackInfo=void 0;const ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js");class AbstractMakePackInfo extends ohos_hap_task_js_1.OhosHapTask{doMakePackInfo(e,t,o,s,a,n,r=!1){const u=t.getTargetName(),i=s.getJsonObjByTargetName(u),c=r?n.getModuleObj(i):n.getModuleObj(i,s,u),l=this.service.getRelatedEntryModules();let _;if(u===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(_=r?n.getModuleObj(s.getJsonObjByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),i.app.apiVersion):n.getModuleObj(s.getJsonObjByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),s,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET)),this.noRelatedEntryModules(l)){const o=[c];return _&&o.push(_),void this.buildPackInfo(e,"",t,i,a,o,void 0)}for(const s of l)if(o.getModuleModelByName(s)){const l=o.getModuleModelByName(s),d=l.getJsonObjByTargetName(u),f=[c,r?n.getModuleObj(d,i.app.apiVersion):n.getModuleObj(d,l,u)];if(_){f.push(_);const e=r?n.getModuleObj(l.getJsonObjByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),i.app.apiVersion):n.getModuleObj(l.getJsonObjByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),l,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);f.push(e)}this.buildPackInfo(e,s,t,i,a,f,d)}}buildPackInfo(e,t,o,s,a,n,r){const u=o.getModuleTargetOutputFileName(t,null),i=u.substring(0,u.lastIndexOf(".hap")),c=r?this.getPackageObj(s,i,r):this.getPackageObj(s,i),l=this.getPackInfoObj(a,n,c);this.outputJSON(e,l,o.getPathInfo().getModuleBuildOutputPath(),t)}processForms(e){if(void 0===e)return;const t=[];for(let o=0;o<e.length;o++){const s=e[o],a={name:s.name,type:"JS",updateEnabled:s.updateEnabled,scheduledUpdateTime:s.scheduledUpdateTime,updateDuration:s.updateDuration,supportDimensions:s.supportDimensions,defaultDimension:s.defaultDimension};t.push(a)}return t}processAbilities(e){if(void 0===e)return;const t=[];for(const{forms:o,label:s,name:a,visible:n}of e){const e={name:a,label:s,visible:n,forms:this.processForms(o)};t.push(e)}return t}outputJSON(e,t,o,s){e.debug("Module Pack Info: ",t),fse.outputJSONSync(path_1.default.resolve(o,s,build_directory_const_js_1.BuildArtifactConst.PACK_INFO),t)}getPackInfoObj(e,t,o){return{summary:{app:e,modules:t},packages:[o]}}noRelatedEntryModules(e){return 0===e.length}}exports.AbstractMakePackInfo=AbstractMakePackInfo;