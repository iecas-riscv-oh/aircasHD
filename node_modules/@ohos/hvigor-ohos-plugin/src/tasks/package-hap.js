"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,o){void 0===o&&(o=t);var a=Object.getOwnPropertyDescriptor(s,t);a&&!("get"in a?!s.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,o,a)}:function(e,s,t,o){void 0===o&&(o=t),e[o]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageHap=void 0;const fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../builder/inner-java-command-builder/packing-tool-options.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_utils_js_1=require("../utils/process-utils.js"),build_native_with_ninja_js_1=require("./build-native-with-ninja.js"),task_names_js_1=require("./common/task-names.js"),compile_node_js_1=require("./compile-node.js"),make_pack_info_js_1=require("./make-pack-info.js"),process_libs_js_1=require("./process-libs.js"),syscap_transform_js_1=require("./syscap-transform.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");var Task=task_names_js_1.TaskNames.Task;class PackageHap extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,Task.PACKAGE_HAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(PackageHap.name)}initTaskDepends(){this.module.registryDependsOnTask(this,new make_pack_info_js_1.MakePackInfo(this.service),new process_libs_js_1.ProcessLibs(this.service),new compile_node_js_1.CompileNode(this.service,code_type_enum_js_1.CodeType.ETS,task_names_js_1.TaskNames.Task.COMPILE_NODE),new compile_node_js_1.CompileNode(this.service,code_type_enum_js_1.CodeType.JS,task_names_js_1.TaskNames.Task.COMPILE_NODE),new build_native_with_ninja_js_1.BuildNativeWithNinja(this.service),new syscap_transform_js_1.SyscapTransform(this.service))}doTaskAction(e){const s=e.getPathInfo(),t=this.service.getSdkInfo().getPackageTool(),o=this.service.getRelatedEntryModules();if(o.length)for(const a of o)this.module.findModuleByName(a)&&this.executeCommandList(s,t,e,this.moduleName,this.name,a);else this.executeCommandList(s,t,e,this.moduleName,this.name)}executeCommandList(e,s,t,o,a,i){const _=new packing_tool_options_js_1.PackingToolOptions,n=i||"";_.addCalledJarFile(s),_.addMode("hap").force(!0).addLibPath(e.getIntermediatesProcessLibs()).addJsonPath(path_1.default.resolve(e.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON)).addResourcesPath(path_1.default.resolve(e.getIntermediatesRes(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES)).addIndexPath(path_1.default.resolve(e.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_INDEX)).addPackInfoPath(path_1.default.resolve(e.getModuleBuildOutputPath(),n,build_directory_const_js_1.BuildArtifactConst.PACK_INFO)).addOutPath(path_1.default.resolve(e.getModuleBuildOutputPath(),t.getModuleTargetOutputFileName(n,!1)));const r=path_1.default.resolve(e.getIntermediatesSysCap(),common_const_js_1.CommonConst.RPCID_SC);fse.existsSync(r)&&_.addSysCapPath(r);const d=path_1.default.resolve(e.getIntermediatesAssetsPath(),"js");fse.existsSync(d)&&_.addJsPath(d);const c=path_1.default.resolve(e.getIntermediatesAssetsPath(),"ets");fse.existsSync(c)&&_.addEtsPath(c);const u=path_1.default.resolve(e.getIntermediatesAssetsPath(),common_const_js_1.CommonNodeConst.NODE_MODULES);fse.existsSync(u)&&_.addDirList([u]),this._log._printDebugCommand("PackageHap",_.build()),new process_utils_js_1.ProcessUtils(o,a).executeSync(_.build())}}exports.PackageHap=PackageHap;