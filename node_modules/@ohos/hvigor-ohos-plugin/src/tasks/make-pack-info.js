"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MakePackInfo=void 0;const ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),merge_profile_js_1=require("./merge-profile.js");var Task=task_names_js_1.TaskNames.Task;const abstract_make_pack_info_js_1=require("./abstract-make-pack-info.js");class MakePackInfo extends abstract_make_pack_info_js_1.AbstractMakePackInfo{constructor(e){super(e,Task.MAKE_PACK_INFO),this._log=ohos_logger_js_1.OhosLogger.getLogger(MakePackInfo.name)}initTaskDepends(){this.module.registryDependsOnTask(this,new merge_profile_js_1.MergeProfile(this.service))}doTaskAction(e){const s=this.service.getModuleModel(),o=this.service.getProjectModel(),t=o.getAppRes().getAppResOpt(),i=e.getProduct().bundleName,a={code:t.app.versionCode,name:t.app.versionName,minCompatibleVersionCode:t.app.minCompatibleVersionCode},r={bundleName:null!=i?i:t.app.bundleName,version:a};this.doMakePackInfo(this._log,e,o,s,r,this)}processExtensionAbilities(e,s,o){if(void 0===e)return;const t=[];for(const i of e){const e={name:i.name,forms:this.processForms(MakePackInfo.processMetaData(i.metadata,s,o))};t.push(e)}return t}static processMetaData(e,s,o){if(void 0===e)return;const t=[];for(const i of e){const e=MakePackInfo.processResourcePath(i.resource);if(i.name&&i.name.indexOf("form")>=0&&void 0!==e){const i=s.getFormJsonObjByTargetName(o,e).forms;for(let e=0;e<i.length;e++)t.push(i[e])}}return t}static processResourcePath(e){if(!e)return;const s=e.split(":");return 2!==s.length||"$"!==s[0].charAt(0)||s[0].length<2?void 0:`base/${s[0].substring(1)}/${s[1]}.json`}getModuleObj(e,s,o){const t={moduleType:e.module.type,installationFree:e.module.installationFree,deliveryWithInstall:e.module.deliveryWithInstall,moduleName:e.module.name},i={compatible:this.service.getProjectModel().getCompatibleApiVersion(),releaseType:this.sdkInfo.getReleaseType(),target:this.service.getProjectModel().getCompileApiVersion()};return{mainAbility:e.module.mainElement,deviceType:e.module.deviceTypes,abilities:this.processAbilities(e.module.abilities),extensionAbilities:this.processExtensionAbilities(e.module.extensionAbilities,s,o),distro:t,apiVersion:i}}getPackageObj(e,s,o){return{deviceType:o?o.module.deviceTypes:e.module.deviceTypes,moduleType:e.module.type,deliveryWithInstall:e.module.deliveryWithInstall,name:s}}}exports.MakePackInfo=MakePackInfo;