"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,s)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenerateLoaderJson=void 0;const path_1=__importDefault(require("path")),fse=__importStar(require("fs-extra")),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),property_get_js_1=require("../sdk/lib/property-get.js"),pre_build_js_1=require("./pre-build.js"),task_names_js_1=require("./common/task-names.js"),build_directory_const_js_1=require("../const/build-directory-const.js");var Task=task_names_js_1.TaskNames.Task;const common_const_js_1=require("../const/common-const.js");class GenerateLoaderJson extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,Task.GENERATE_LOADER_JSON),this._log=ohos_logger_js_1.OhosLogger.getLogger(GenerateLoaderJson.name)}initTaskDepends(){this.module.registryDependsOnTask(this,new pre_build_js_1.PreBuild(this.service))}doTaskAction(e){const t=path_1.default.resolve(e.getPathInfo().getIntermediatesLoaderPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON);fse.outputJSONSync(t,{workers:this.getWorkerConfig(),modulePathMap:this.getModulePathMap(),compileMode:this.moduleModel.getCompileMode(),projectRootPath:this.service.getProjectModel().getProjectDir(),nodeModulesPath:path_1.default.resolve(e.getPathInfo().getIntermediatesAssetsPath(),common_const_js_1.CommonNodeConst.NODE_MODULES)})}beforeTask(e){const t=e.getPathInfo().getIntermediatesLoaderPath();fse.removeSync(t)}getWorkerConfig(){var e,t,o;const r=[],s=this.service.getModuleModel();if(null===(o=null===(t=null===(e=s.getProfileOpt().buildOption)||void 0===e?void 0:e.sourceOption)||void 0===t?void 0:t.workers)||void 0===o||o.forEach((e=>{const t=path_1.default.isAbsolute(e)?e:path_1.default.resolve(s.getProjectDir(),e);property_get_js_1.Property.normalizePathSeparator(t).startsWith(property_get_js_1.Property.normalizePathSeparator(this.moduleModel.getProjectDir()))?r.push(t):this._log._buildError(`${e} is not under ${this.moduleModel.getProjectDir()}`)._solution(`modify ${e} in build-profile.json5`)._file(this.moduleModel.getProfilePath())._printErrorAndExit()})),0!==r.length)return r}getModulePathMap(){const e={};return this.service.getProjectModel().getSubProjects().forEach(((t,o)=>{e[o]=t.getProjectDir()})),e}}exports.GenerateLoaderJson=GenerateLoaderJson;