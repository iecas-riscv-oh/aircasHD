"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,i){void 0===i&&(i=t);var r=Object.getOwnPropertyDescriptor(s,t);r&&!("get"in r?!s.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,i,r)}:function(e,s,t,i){void 0===i&&(i=t),e[i]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageHar=void 0;const json5_reader_js_1=require("@ohos/hvigor-base/src/util/json5-reader.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),system_util_js_1=require("../utils/system-util.js"),syscap_transform_js_1=require("./syscap-transform.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),path_1=__importDefault(require("path")),fs=__importStar(require("fs-extra")),process_utils_js_1=require("../utils/process-utils.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),npm_command_builder_js_1=require("../builder/npm-command-builder.js"),task_names_js_1=require("./common/task-names.js"),process_libs_js_1=require("./process-libs.js"),compile_resource_js_1=require("./compile-resource.js"),legacy_compile_resource_js_1=require("./legacy-tasks/legacy-compile-resource.js");var Task=task_names_js_1.TaskNames.Task;const cmake_util_js_1=require("../utils/cmake-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("PackageHar"),isFileSpec=(0,system_util_js_1.isWindows)()?/^(?:[.]|~[/]|[/\\]|[a-zA-Z]:)/:/^(?:[.]|~[/]|[/]|[a-zA-Z]:)/,hasSlashes=(0,system_util_js_1.isWindows)()?/\\|[/]/:/[/]/,isFileName=/[.](?:tgz|tar.gz|tar)$/i;class PackageHar extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var s;super(e,Task.PACKAGE_HAR);const t=e.getModuleModel().getProfileOpt();this._nativeOption=null===(s=t.buildOption)||void 0===s?void 0:s.externalNativeOptions,this._sdkInfo=this.service.getSdkInfo()}initTaskDepends(){this.module.registryDependsOnTask(this,new process_libs_js_1.ProcessLibs(this.service),this.isFaMode?new legacy_compile_resource_js_1.LegacyCompileResource(this.service):new compile_resource_js_1.CompileResource(this.service),new syscap_transform_js_1.SyscapTransform(this.service))}doTaskAction(e){var s;const t=e.getPathInfo(),i=this.moduleModel.getProjectDir(),r=t.getIntermediatesProcessLibs(),o=t.getIntermediatesRes(),a=this.moduleModel.getPackageJsonPath();PackageHar.checkHasLocalFileDependency(a)&&_log._buildError("Local dependencies are not supported when building an HAR. This will cause error when installing the resulting HAR. Please check the package.json of current library module.")._file(a)._solution("Remove local dependency of current library module.")._printErrorAndExit(),fs.emptyDirSync(t.getModuleBuildOutputPath()),fs.emptyDirSync(this.getTaskTempDir(e)),fs.pathExistsSync(r)&&fs.copySync(t.getIntermediatesProcessLibs(),path_1.default.resolve(this.getTaskTempDir(e),build_directory_const_js_1.BuildDirConst.LIBS)),fs.pathExistsSync(o)&&fs.copySync(path_1.default.resolve(o,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),path_1.default.resolve(this.getTaskTempDir(e),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT));let n=[build_directory_const_js_1.BuildDirConst.LIBS,build_directory_const_js_1.BuildDirConst.BUILD_ROOT,common_const_js_1.CommonNodeConst.NODE_MODULES,".cxx",".preview"];n.includes(t.getBuildRoot())||n.push(t.getBuildRoot()),n=n.map((e=>path_1.default.resolve(i,e)));const c=cmake_util_js_1.CmakeUtil.getCmakeListDir(i,null===(s=this._nativeOption)||void 0===s?void 0:s.path);if(fs.readdirSync(i).forEach((s=>{const t=path_1.default.resolve(i,s);n.includes(t)||fs.copySync(path_1.default.resolve(i,s),path_1.default.resolve(this.getTaskTempDir(e),s),{filter:e=>!(this._nativeOption&&e===c)})})),this._nativeOption){const s=path_1.default.resolve(c,"types");fs.pathExistsSync(s)&&fs.copySync(s,path_1.default.resolve(this.getTaskTempDir(e),"src","main","cpp","types"))}const _=t.getIntermediatesMergeProfileDir();fs.copySync(_,path_1.default.resolve(this.getTaskTempDir(e),"src","main"));const l=path_1.default.resolve(this.getTaskTempDir(e),"src","main",common_const_js_1.CommonConst.MODULE_JSON5);fs.pathExistsSync(l)&&fs.removeSync(l);const u=path_1.default.dirname(process.execPath),d=new npm_command_builder_js_1.NpmCommandBuilder(u);d.addAllParams(["pack"]);const p=new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(d.build(),{cwd:this.getTaskTempDir(e)},!0).stdout.toString();fs.copySync(this.getTaskTempDir(e),t.getModuleBuildOutputPath(),{filter:s=>!fs.lstatSync(s).isDirectory()&&s.endsWith(p)||s===this.getTaskTempDir(e)})}static checkHasLocalFileDependency(e){const s=json5_reader_js_1.Json5Reader.getJson5Obj(e);return void 0!==s.dependencies&&Object.values(s.dependencies).some((e=>PackageHar.isLocalDependency(e)))}static isLocalDependency(e){return!!e&&(isFileSpec.test(e)||/^file:/i.test(e)||hasSlashes.test(e)||isFileName.test(e))}}exports.PackageHar=PackageHar;