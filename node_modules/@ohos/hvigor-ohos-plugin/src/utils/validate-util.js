"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,o)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ValidateUtil=void 0;const ajv_1=__importDefault(require("ajv")),array_util_js_1=require("./array-util.js"),project_file_reader_js_1=require("./project-file-reader.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),util=__importStar(require("util")),os=__importStar(require("os")),fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),java_command_builder_js_1=require("../builder/java-command-builder.js"),process_utils_js_1=require("./process-utils.js"),common_const_js_1=require("../const/common-const.js"),hvigor_base_1=require("@ohos/hvigor-base");class ValidateUtil{static schemaCheckOnly(e,t,i){return new ajv_1.default({strict:!1,allErrors:!0}).compile(i)(project_file_reader_js_1.ProjectFileReader.getJson5Obj(t))}static doSchemaCheck(e,t,i){var r;const o=new ajv_1.default({strict:!1,allErrors:!0}).compile(i),a=project_file_reader_js_1.ProjectFileReader.getJson5Obj(t);let l="Please check the following fields.";if(o(a))ValidateUtil._log.debug(`Schema ${t} success.`);else{if(!o.errors)return;const i=(0,hvigor_base_1.parseJsonFile)(t,!0),n=[];if(null===(r=o.errors)||void 0===r||r.forEach((e=>{const r={instancePath:e.instancePath,keyword:e.keyword,params:e.params,message:e.message,location:`${t.replace(/\\/g,"/")}`};ValidateUtil.isPhoneToWarning(e.instancePath,a)?ValidateUtil._log.warn("The device type 'phone' in the module.json5 or config.json is not supported currently, you are advised to change the device type to 'default'. "):(ValidateUtil.addLocationInfo(r,i),n.push(r))})),(ValidateUtil.isSpecialHandle("startWindowIcon",o.errors)||ValidateUtil.isSpecialHandle("startWindowBackground",o.errors))&&(l=`For help about startWindows, ${l[0].toLowerCase()+l.substring(1)}`),0!==n.length){let t="";null==n||n.forEach((e=>{t+=util.format(e,os.EOL)})),ValidateUtil._log._buildError("Schema validate failed.")._solution(`${l}${os.EOL}${t}`)._printErrorAndExit(e)}}}static addLocationInfo(e,t){var i;let r="",o=t;null===(i=e.instancePath)||void 0===i||i.split("/").forEach((e=>{null===e||""===e||("NaN"===parseInt(e).toString()?(o=o[e],r+=""===r?e:`.${e}`):(o=o[parseInt(e)],r+=`[${e}]`))})),e.instancePath=r,e.location+=`:${o._line}:${o._column+1}`}static isPhoneToWarning(e,t){var i,r;const o=e.lastIndexOf("/"),a=e.substring(o+1),l=parseInt(a),n=null===(i=t.module)||void 0===i?void 0:i.deviceTypes,s=null===(r=t.module)||void 0===r?void 0:r.deviceType,d=void 0===n?s:n;return!!Array.isArray(d)&&(-1!==e.indexOf("deviceType")&&d.indexOf("phone")===l)}static isSpecialHandle(e,t){return!!t&&t.some((t=>-1!==t.keyword.indexOf("required")&&t.params.missingProperty===e))}static getBundleNameFromP7b(e,t){if(void 0!==t){const i=e.getSdkInfo().getVerifySignConfigTool();""!==i&&fs.existsSync(path_1.default.resolve(i))||ValidateUtil._log._buildError("The relevant HAP signing tool is not found in the SDK.")._solution("Please check the toolchains directory of the SDK.")._file(e.getSdkInfo().getSdkToolchainsDir())._printErrorAndExit();const r=t.material.profile,o=fs.mkdtempSync("TempDirForSignConfigCheck"),a=path_1.default.resolve(o,"signConfigCheckJson.json"),l=(new java_command_builder_js_1.JavaCommandBuilder).addCalledJarFile(i).addJvmOption("verify-profile").addJvmOption("-inFile").addJvmOption(r).addJvmOption("-outFile").addJvmOption(a).build();(new process_utils_js_1.ProcessUtils).executeSync(l);const n=project_file_reader_js_1.ProjectFileReader.getJson5Obj(a).content["bundle-info"]["bundle-name"];return fs.existsSync(a)&&(fs.removeSync(a.toString()),fs.removeSync(o)),n}return null}static getBundleNameFromHap(e,t){var i;const r=e.bundleName;if(r)return r;const o=null===(i=t.getModuleModel())||void 0===i?void 0:i.getSourceRootByTargetName();if(t.getHapExtraInfo().isStageMode())return t.getProjectModel().getDefaultBundleName();const a=path_1.default.resolve(o,common_const_js_1.CommonConst.CONFIG_JSON);return project_file_reader_js_1.ProjectFileReader.getJson5Obj(a).app.bundleName}static searchDuplicateName(e){return(0,array_util_js_1.findDuplicateElement)(e.map((e=>e.name)))}static validateDuplicatedName(e,t,i){if(void 0===e)return;const r=ValidateUtil.searchDuplicateName(e);0!==r.length&&ValidateUtil._log._buildError(`Duplicated ${t}: ${r.join(",")}.`)._solution(`Make sure all ${t}' name are unique.`)._file(i)._printErrorAndExit()}static validateContainsDefault(e,t){e&&e.some((e=>"default"===e.name))||ValidateUtil._log._buildError("Could not find or load default product.")._solution("Add a product named 'default' into build-profile.json5.")._file(t)._printErrorAndExit()}static isDeviceTypeExist(e,t){return e.some((e=>t.includes(e)))}static isAllLiteDeviceType(e,t){return e.every((e=>t.includes(e)))}static validateHybridDeviceTypes(e){ValidateUtil.isDeviceTypeExist(e,ValidateUtil.richDeviceTypes)&&ValidateUtil.isDeviceTypeExist(e,ValidateUtil.liteDeviceTypes)?ValidateUtil._log._buildError("It's not allowed to configure lite device in deviceType when rich device exist.")._solution("Check whether the device type field is correctly configured.")._printErrorAndExit():ValidateUtil.isAllLiteDeviceType(e,ValidateUtil.liteDeviceTypes)&&e.length>1&&ValidateUtil._log._buildError("It's not allowed to configure more than one lite device")._solution("Check whether the device type field is correctly configured.")._printErrorAndExit()}static validateFALiteDevice(e){e.some((e=>ValidateUtil.liteDeviceTypes.includes(e)))&&ValidateUtil._log._buildError("It's not allowed to configure lite device in FA project")._solution("Check whether the device type field is correctly configured in config.json.")._printErrorAndExit()}}exports.ValidateUtil=ValidateUtil,ValidateUtil._log=ohos_logger_js_1.OhosLogger.getLogger(ValidateUtil.name),ValidateUtil.richDeviceTypes=["phone","tablet","tv","wearable","car"],ValidateUtil.liteDeviceTypes=["lite Wearable","smart Vision","router"];